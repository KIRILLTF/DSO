name: Security - SBOM & SCA

on:
  workflow_dispatch:
  push:
    paths:
      - "**/*.py"
      - "requirements*.txt"
      - ".github/workflows/ci-sbom-sca.yml"

permissions:
  contents: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  sbom_sca:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Ensure evidence dirs
        run: mkdir -p EVIDENCE/P09

      - name: Generate SBOM with metadata
        run: |
          docker run --rm -v $PWD:/work -w /work anchore/syft:latest \
            scan dir:. --scope all-layers --output cyclonedx-json --file EVIDENCE/P09/sbom.json
          
          echo "commit: ${{ github.sha }}" > EVIDENCE/P09/sbom_metadata.txt
          echo "repository: ${{ github.repository }}" >> EVIDENCE/P09/sbom_metadata.txt
          echo "workflow_run: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}" >> EVIDENCE/P09/sbom_metadata.txt
          echo "generated_at: $(date -u +"%Y-%m-%dT%H:%M:%SZ")" >> EVIDENCE/P09/sbom_metadata.txt
          echo "syft_version: $(docker run --rm anchore/syft:latest version)" >> EVIDENCE/P09/sbom_metadata.txt

      - name: SCA Scan
        run: |
          docker run --rm -v $PWD:/work -w /work anchore/grype:latest \
            sbom:/work/EVIDENCE/P09/sbom.json -o json > EVIDENCE/P09/sca_report.json
          
          echo "grype_version: $(docker run --rm anchore/grype:latest version)" >> EVIDENCE/P09/sbom_metadata.txt

      - name: Build enhanced SCA summary
        run: |
          echo "# SCA Summary" > EVIDENCE/P09/sca_summary.md
          echo "" >> EVIDENCE/P09/sca_summary.md
          echo "## Scan Metadata" >> EVIDENCE/P09/sca_summary.md
          echo "- Commit: [${{ github.sha }}](https://github.com/${{ github.repository }}/commit/${{ github.sha }})" >> EVIDENCE/P09/sca_summary.md
          echo "- Branch: ${{ github.ref_name }}" >> EVIDENCE/P09/sca_summary.md
          echo "- Workflow run: [#${{ github.run_id }}](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> EVIDENCE/P09/sca_summary.md
          echo "- Generated: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> EVIDENCE/P09/sca_summary.md
          echo "- Tools: $(docker run --rm anchore/syft:latest version), $(docker run --rm anchore/grype:latest version)" >> EVIDENCE/P09/sca_summary.md
          
          echo "" >> EVIDENCE/P09/sca_summary.md
          echo "## Vulnerability Summary" >> EVIDENCE/P09/sca_summary.md
          echo "| Severity | Count |" >> EVIDENCE/P09/sca_summary.md
          echo "|----------|-------|" >> EVIDENCE/P09/sca_summary.md
          
          if [ -s EVIDENCE/P09/sca_report.json ]; then
            for sev in Critical High Medium Low Unknown; do
              count=$(jq '[.matches[].vulnerability.severity | select(. == "'"$sev"'")] | length' EVIDENCE/P09/sca_report.json 2>/dev/null || echo "0")
              echo "| $sev | $count |" >> EVIDENCE/P09/sca_summary.md
            done
          else
            echo "| No vulnerabilities found | 0 |" >> EVIDENCE/P09/sca_summary.md
          fi
          
          echo "" >> EVIDENCE/P09/sca_summary.md
          echo "## Top Vulnerabilities (High+)" >> EVIDENCE/P09/sca_summary.md
          
          if [ -s EVIDENCE/P09/sca_report.json ] && [ "$(jq '.matches | length' EVIDENCE/P09/sca_report.json)" -gt 0 ]; then
            echo "| CVE ID | Package | Version | Severity |" >> EVIDENCE/P09/sca_summary.md
            echo "|--------|---------|---------|----------|" >> EVIDENCE/P09/sca_summary.md
            
            jq -r '.matches[] | select(.vulnerability.severity == "High" or .vulnerability.severity == "Critical") 
              | "| \(.vulnerability.id) | \(.artifact.name) | \(.artifact.version) | \(.vulnerability.severity) |"' \
              EVIDENCE/P09/sca_report.json | head -10 >> EVIDENCE/P09/sca_summary.md
            
            critical_count=$(jq '[.matches[].vulnerability.severity | select(. == "Critical")] | length' EVIDENCE/P09/sca_report.json)
            high_count=$(jq '[.matches[].vulnerability.severity | select(. == "High")] | length' EVIDENCE/P09/sca_report.json)
            
            echo "" >> EVIDENCE/P09/sca_summary.md
            echo "## Action Plan" >> EVIDENCE/P09/sca_summary.md
            
            if [ "$critical_count" -gt 0 ]; then
              echo "### Immediate Actions (Critical: $critical_count)" >> EVIDENCE/P09/sca_summary.md
              echo "1. Анализ всех Critical уязвимостей" >> EVIDENCE/P09/sca_summary.md
              echo "2. Обновление зависимостей до безопасных версий" >> EVIDENCE/P09/sca_summary.md
              echo "3. Проверить waivers в [policy/waivers.yml](../../policy/waivers.yml)" >> EVIDENCE/P09/sca_summary.md
            fi
            
            if [ "$high_count" -gt 0 ]; then
              echo "### Near-term Actions (High: $high_count)" >> EVIDENCE/P09/sca_summary.md
              echo "1. Обновление в течение следующего спринта" >> EVIDENCE/P09/sca_summary.md
              echo "2. Оценка рисков для каждого CVE" >> EVIDENCE/P09/sca_summary.md
            fi
          else
            echo "Нет High/Critical уязвимостей." >> EVIDENCE/P09/sca_summary.md
            echo "" >> EVIDENCE/P09/sca_summary.md
            echo "## Action Plan" >> EVIDENCE/P09/sca_summary.md
            echo "Нет критических или высокоуровневых уязвимостей. Продолжать регулярное сканирование." >> EVIDENCE/P09/sca_summary.md
          fi
          
          echo "" >> EVIDENCE/P09/sca_summary.md
          echo "## Next Steps" >> EVIDENCE/P09/sca_summary.md
          echo "1. Просмотреть полный отчет: [sca_report.json](./sca_report.json)" >> EVIDENCE/P09/sca_summary.md
          echo "2. Обновить зависимости через PR" >> EVIDENCE/P09/sca_summary.md
          echo "3. Проверить актуальность waivers в [policy/waivers.yml](../../policy/waivers.yml)" >> EVIDENCE/P09/sca_summary.md

      - name: Commit and push evidence to branch
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          if git diff --quiet HEAD -- EVIDENCE/P09/; then
            echo "No changes in EVIDENCE/P09"
          else
            git add EVIDENCE/P09/
            git commit -m "P09: update SBOM & SCA evidence [skip ci]"
            git push origin HEAD:${GITHUB_REF_NAME}
          fi

      - name: Upload evidence as artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: P09_EVIDENCE_${{ github.run_id }}
          path: EVIDENCE/P09
