# ADR-001: Архитектурный выбор медиасервиса

## Context

* В рамках проекта создается медиасервис, обеспечивающий загрузку, хранение, обработку и предоставление медиафайлов пользователям.
* Основные задачи: высокая масштабируемость, безопасность пользовательских данных, стабильная доставка контента и интеграция с системой аутентификации.
* Также требуется поддержка микросервисной архитектуры для независимого масштабирования модулей, аутентификации, обработки и API.

## Decision

* Принято решение реализовать сервис в виде набора микросервисов, взаимодействующих через REST API и брокер сообщений.
* Основные сервисы:

  * **AuthService** — отвечает за JWT-аутентификацию и авторизацию.
  * **MediaService** — управляет загрузкой, хранением и обработкой файлов.
  * **Gateway** — единственная точка входа (API Gateway), маршрутизирующая запросы к внутренним сервисам.
* Данные пользователей и метаданные медиафайлов хранятся в PostgreSQL; файлы — в S3-совместимом хранилище.
* Для асинхронных задач используется RabbitMQ, а для логирования и метрик — Prometheus и Grafana.

## Alternatives

* **Монолитная архитектура**: проще в реализации, но хуже масштабируется и менее устойчива к сбоям.
* **Событийно-ориентированная архитектура (Event-driven)**: выше гибкость, но увеличивает сложность отладки и мониторинга.
* **Serverless**: снижает нагрузку на DevOps, но ограничивает контроль над безопасностью и задержками.

## Consequences

* **Плюсы**:

  * Легкое масштабирование отдельных модулей.
  * Четкое разделение ответственности.
  * Возможность обновления и тестирования сервисов независимо.
* **Минусы**:

  * Более сложное развертывание и мониторинг.
  * Потенциально выше задержки из-за сетевого взаимодействия.
  * Необходимость защиты межсервисных коммуникаций.

## Security impact

* Все запросы проходят через API Gateway, где выполняется валидация JWT и проверка прав.
* Коммуникации между сервисами защищены TLS.
* Используется принцип наименьших привилегий: доступ к хранилищу данных и S3 ограничен ролями.
* Аутентификация — только через централизованный AuthService.
* Логи доступа и событий безопасности сохраняются для аудита.

## Rollout plan

1. Создать репозитории для всех микросервисов.
2. Настроить CI/CD с линтингом, тестами и деплоем.
3. Реализовать базовые API для аутентификации и загрузки медиа.
4. Настроить API Gateway и маршрутизацию.
5. Включить централизованное логирование и мониторинг.
6. Провести нагрузочное и security-тестирование перед продакшеном.

## Links

* **NFR**: Требования к масштабируемости, отказоустойчивости и безопасности.
* **DFD**: Потоки F1–F8 (регистрация, загрузка, доступ к контенту).
* **RISKS**: R1 — несанкционированный доступ, R2 — утечка данных, R3 — сбой межсервисных коммуникаций.
* **STRIDE**: Spoofing — через API; Information disclosure — при неправильных правах доступа; Denial of Service — при перегрузке медиасервиса.