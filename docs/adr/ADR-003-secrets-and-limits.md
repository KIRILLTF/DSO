# ADR-003: Secrets и File Limits

## Context

* Загрузка файлов может быть источником атак через вредоносные расширения или слишком большие файлы.
* Секреты приложения (ключи, токены) необходимо хранить безопасно, чтобы не попасть в репозиторий или логи.

## Decision

* Все секреты хранятся в переменных окружения или защищённом хранилище (Vault).
* Реализован сервис `MediaSecurityService`, который централизует проверку файлов:

  * Ограничение размера: до 5 MB.
  * Разрешённые расширения: png, jpg, jpeg, gif.
  * Очистка имени файла с помощью `os.path.basename`.
* Все эндпоинты загрузки файлов используют этот сервис.

## Alternatives

* Хранение секретов в коде — небезопасно и повышает риск утечки.
* Полностью открытые загрузки файлов — опасно, возможны атаки на систему.
* Использовать сторонние сервисы для проверки файлов — добавляет зависимость и задержку.

## Consequences

* **Плюсы**:

  * Централизованная проверка и защита от path traversal и вредоносных файлов.
  * Минимизация риска утечки секретов.
* **Минусы**:

  * Необходимость поддержки инфраструктуры для безопасного хранения секретов.
  * Ограничение размера файлов может быть неудобным для пользователей.

## Security impact

* Исключает path traversal и загрузку вредоносных файлов.
* Секреты не хранятся в репозитории и не попадают в логи.
* Минимизирует риск DoS через большие файлы.

## Rollout plan

1. Перенести все секреты в Vault или переменные окружения.
2. Реализовать `MediaSecurityService` для всех эндпоинтов.
3. Протестировать ограничения по размеру и расширению файлов.
4. Обновить документацию и примеры использования API.

## Links

* **NFR**: Безопасность загрузки, отказоустойчивость.
* **DFD**: Потоки загрузки файлов.
* **RISKS/STRIDE**: R1, R2, R3; Tampering, Information disclosure, DoS.

