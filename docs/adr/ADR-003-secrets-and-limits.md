# ADR-003: Secrets и ограничения загрузки файлов

## Context

* Загрузка файлов пользователями может стать источником атак: переполнение, вредоносные расширения, утечка данных.
* Необходимо хранить секреты и ключи безопасно, а также ограничивать размер и тип файлов.

## Decision

* Секреты (API-ключи, токены) хранятся в переменных окружения и Vault.
* Файлы проверяются по расширению и размеру:

  * ALLOWED_EXTENSIONS = {"png", "jpg", "jpeg", "gif"}
  * MAX_FILE_SIZE_MB = 5
* Имена файлов проходят простую очистку (`os.path.basename`) для предотвращения path traversal.
* Сервис MediaSecurityService централизует проверки и безопасную обработку файлов.

## Alternatives

* **Хранение секретов в коде**: упрощает локальную разработку, но крайне небезопасно.
* **Полностью открытые загрузки**: нет ограничений по типу и размеру — риск утечки и DoS.

## Consequences

* **Плюсы**:

  * Безопасная работа с файлами.
  * Консистентная обработка ошибок и ограничений.
  * Минимизация риска утечки секретов.
* **Минусы**:

  * Требуется поддержка инфраструктуры (Vault, переменные окружения).
  * Ограничение на размер может вызвать неудобства для пользователей.

## Security impact

* Защита от path traversal и загрузки вредоносных файлов.
* Секреты не попадают в репозиторий и логи.
* Файлы проверяются на расширение и размер, исключая DoS-атаки через перегрузку сервиса.

## Rollout plan

1. Перенести все ключи в Vault/переменные окружения.
2. Реализовать MediaSecurityService с проверкой расширения и размера.
3. Протестировать ограничения на всех эндпоинтах.
4. Обновить документацию и добавить примеры ограничений.

## Links

* **NFR**: Безопасность загрузки, отказоустойчивость.
* **DFD**: Потоки загрузки файлов.
* **RISKS**: R1 — вредоносный файл; R2 — превышение размера; R3 — утечка секретов.
* **STRIDE**: Tampering — при изменении файлов; Information disclosure — при утечке секретов; Denial of Service — при больших файлах.

