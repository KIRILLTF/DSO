# ADR-002: RFC7807-совместимые ошибки

## Context

* В API проекта требуется стандартизированный формат ошибок, чтобы клиенты могли однозначно обрабатывать ответы.
* Стандарт RFC7807 определяет структуру JSON для ошибок: `type`, `title`, `status`, `detail` и `instance`.
* Цель — единообразие и удобство интеграции сторонних сервисов.

## Decision

* Принято решение использовать RFC7807 как основной формат ошибок для всех REST API-эндпоинтов.
* Внутри сервиса создается базовый обработчик исключений, который автоматически преобразует HTTPException и кастомные ошибки в RFC7807 JSON.
* Заголовки HTTP и статус-коды соответствуют REST-стандартам.

## Alternatives

* **Произвольные JSON ошибки**: проще в реализации, но клиенты должны обрабатывать множество форматов.
* **Только текстовые ошибки**: потеря структуры, сложно автоматизировать обработку.

## Consequences

* **Плюсы**:

  * Единый формат ошибок для всех клиентов.
  * Улучшенная интеграция и поддержка сторонних SDK.
* **Минусы**:

  * Требуется внедрение middleware или обработчика исключений.
  * Дополнительная работа при обновлении ошибок.

## Security impact

* Не раскрываются внутренние детали ошибок, только безопасные сообщения для клиента.
* Исключения логируются для аудита и отладки, без передачи конфиденциальной информации.

## Rollout plan

1. Создать middleware для перехвата ошибок.
2. Протестировать на всех эндпоинтах API.
3. Обновить документацию и примеры ошибок в Swagger/OpenAPI.
4. Выпустить новую версию API с поддержкой RFC7807.

## Links

* **NFR**: Требования к консистентности API.
* **DFD**: Потоки ошибок от сервиса к клиенту.
* **RISKS**: R4 — неконсистентный формат ошибок; R5 — утечка внутренних данных.
* **STRIDE**: Information disclosure — через текст ошибки; Denial of Service — при некорректной обработке исключений.
